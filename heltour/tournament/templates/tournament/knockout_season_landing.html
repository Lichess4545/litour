{% extends "base.html" %}
{% load static tournament_extras %}
{% block title %}{{ season.name }} - {{ league.name }}{% endblock %}
{% block nav_season %}active{% endblock %}
{% block content %}
    <div class="row row-condensed-xs home-row">
        <div class="col-md-6 col-xs-12">
            {% if active_round %}
                <div class="well">
                    <div class="well-head">
                        <h3>{{ active_round.knockout_stage|title }} - Round {{ active_round.number }}</h3>
                    </div>
                    <div class="well-body">
                        <p>Games must be completed by {{ active_round.end_date | date_el:"m/d H:i" }} UTC.</p>
                        <a href="{% leagueurl 'pairings' league.tag season.tag %}"
                           class="btn btn-default">Current Pairings</a>
                        <a href="{% leagueurl 'knockout_bracket' league.tag season.tag %}"
                           class="btn btn-primary">View Bracket</a>
                    </div>
                </div>
            {% endif %}
            
            {% if bracket_status %}
                <div class="well">
                    <div class="well-head">
                        <h3>Tournament Status</h3>
                    </div>
                    <div class="well-body">
                        {% if bracket_status.is_completed %}
                            <div class="alert alert-success">
                                <strong>Tournament Complete!</strong>
                                {% if bracket_status.champion %}
                                    <br>Champion: 
                                    {% if league.competitor_type == "team" %}
                                        <a class="team-link" href="{% leagueurl 'team_profile' league.tag season.tag bracket_status.champion.number %}">
                                            {{ bracket_status.champion.name }}
                                        </a>
                                    {% else %}
                                        <a href="{% leagueurl 'player_profile' league.tag season.tag bracket_status.champion.lichess_username %}">
                                            {{ bracket_status.champion.lichess_username }}
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% elif bracket_status.current_stage %}
                            <p><strong>Current Stage:</strong> {{ bracket_status.current_stage|title }}</p>
                            <p><strong>Remaining {{ league.competitor_type|title }}s:</strong> {{ bracket_status.remaining_count }}</p>
                        {% else %}
                            <p>Knockout bracket not yet started.</p>
                        {% endif %}
                        
                        <div class="progress" style="margin-top: 15px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ bracket_status.progress_percentage }}%"
                                 aria-valuenow="{{ bracket_status.progress_percentage }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                {{ bracket_status.progress_percentage }}% Complete
                            </div>
                        </div>
                        
                        <a href="{% leagueurl 'knockout_bracket' league.tag season.tag %}"
                           class="btn btn-primary">View Full Bracket</a>
                    </div>
                </div>
            {% endif %}
            
            {% if advancement_info %}
                <div class="well">
                    <div class="well-head">
                        <h3>Tournament Administration</h3>
                    </div>
                    <div class="well-body">
                        {% if advancement_info.can_advance %}
                            <div class="alert alert-info">
                                <strong>Ready to Advance!</strong><br>
                                All matches in Round {{ advancement_info.round_to_advance.number }} are complete.
                            </div>
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" name="advance_tournament" value="1" 
                                        class="btn btn-success"
                                        onclick="return confirm('Are you sure you want to advance the tournament to the next round?')">
                                    <i class="fa fa-forward"></i> Advance to Next Round
                                </button>
                            </form>
                        {% else %}
                            <div class="alert alert-warning">
                                <strong>Cannot Advance:</strong> {{ advancement_info.reason }}
                            </div>
                            {% if advancement_info.tied_matches %}
                                <h4>Tied Matches Requiring Tiebreak Resolution:</h4>
                                <ul class="list-unstyled">
                                    {% for match in advancement_info.tied_matches %}
                                        <li style="margin-bottom: 10px;">
                                            <div class="panel panel-warning">
                                                <div class="panel-body">
                                                    <strong>{{ match.competitor1 }} vs {{ match.competitor2 }}</strong> 
                                                    ({{ match.score }} - {{ match.score }})
                                                    <div style="margin-top: 5px;">
                                                        <a href="{% url 'admin:tournament_teampairing_change' match.id %}" 
                                                           class="btn btn-warning btn-xs">
                                                            Resolve Tiebreak
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            
            {% if finalist_preview %}
                <div class="well">
                    <div class="well-head">
                        <h3>{% if bracket_status.current_stage == "finals" %}Finals{% else %}Advancing to {{ bracket_status.next_stage|title }}{% endif %}</h3>
                    </div>
                    <div class="well-body">
                        <table class="table table-condensed">
                            {% for competitor in finalist_preview %}
                                <tr>
                                    <td>
                                        {% if league.competitor_type == "team" %}
                                            <a class="team-link" href="{% leagueurl 'team_profile' league.tag season.tag competitor.number %}">
                                                {{ competitor.name }}
                                            </a>
                                        {% else %}
                                            <a href="{% leagueurl 'player_profile' league.tag season.tag competitor.lichess_username %}">
                                                {{ competitor.lichess_username }}
                                            </a>
                                        {% endif %}
                                        <span class="text-muted">(Seed {{ competitor.seed }})</span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            {% endif %}
            
            {% if has_more_seasons %}
                <div class="well">
                    <div class="well-head">
                        <h3>Change Season</h3>
                    </div>
                    <div class="well-body">{% include "tournament/season_switcher.html" %}</div>
                </div>
            {% endif %}
        </div>
        
        <div class="col-md-6 col-xs-12">
            {% if recent_results %}
                <div class="well">
                    <div class="well-head">
                        <h3>Recent Results</h3>
                    </div>
                    <div class="well-body">
                        <table class="table table-striped table-round-results">
                            <tbody>
                                {% for result in recent_results %}
                                    <tr>
                                        <td class="cell-score {% if result.competitor1_won %}cell-win{% elif result.competitor2_won %}cell-loss{% else %}cell-tie{% endif %}">
                                            {{ result.competitor1_score|floatformat }}
                                            {% if result.manual_tiebreak and result.competitor1_won %}
                                                <small>(TB)</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if league.competitor_type == "team" %}
                                                <a class="team-link" href="{% leagueurl 'team_profile' league.tag season.tag result.competitor1.number %}">
                                                    {{ result.competitor1.name }}
                                                </a>
                                            {% else %}
                                                <a href="{% leagueurl 'player_profile' league.tag season.tag result.competitor1.lichess_username %}">
                                                    {{ result.competitor1.lichess_username }}
                                                </a>
                                            {% endif %}
                                        </td>
                                        <td class="cell-score {% if result.competitor2_won %}cell-win{% elif result.competitor1_won %}cell-loss{% else %}cell-tie{% endif %}">
                                            {{ result.competitor2_score|floatformat }}
                                            {% if result.manual_tiebreak and result.competitor2_won %}
                                                <small>(TB)</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if league.competitor_type == "team" %}
                                                <a class="team-link" href="{% leagueurl 'team_profile' league.tag season.tag result.competitor2.number %}">
                                                    {{ result.competitor2.name }}
                                                </a>
                                            {% else %}
                                                <a href="{% leagueurl 'player_profile' league.tag season.tag result.competitor2.lichess_username %}">
                                                    {{ result.competitor2.lichess_username }}
                                                </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <a href="{% leagueurl 'knockout_bracket' league.tag season.tag %}"
                           class="btn btn-default">View All Results</a>
                    </div>
                </div>
            {% endif %}
            
            {% if elimination_summary %}
                <div class="well">
                    <div class="well-head">
                        <h3>Recent Eliminations</h3>
                    </div>
                    <div class="well-body">
                        <table class="table table-condensed">
                            <thead>
                                <tr>
                                    <th>{{ league.competitor_type|title }}</th>
                                    <th>Eliminated in</th>
                                    <th>Seed</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for elimination in elimination_summary %}
                                    <tr>
                                        <td>
                                            {% if league.competitor_type == "team" %}
                                                <a class="team-link" href="{% leagueurl 'team_profile' league.tag season.tag elimination.competitor.number %}">
                                                    {{ elimination.competitor.name }}
                                                </a>
                                            {% else %}
                                                <a href="{% leagueurl 'player_profile' league.tag season.tag elimination.competitor.lichess_username %}">
                                                    {{ elimination.competitor.lichess_username }}
                                                </a>
                                            {% endif %}
                                        </td>
                                        <td>{{ elimination.stage|title }}</td>
                                        <td>{{ elimination.seed }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
            
            {% if links_doc %}
                {% include 'tournament/document_inline.html' with document=links_doc.document %}
            {% endif %}
        </div>
    </div>
{% endblock %}